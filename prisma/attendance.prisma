// ==================== ATTENDANCE MODULE ====================
// Contains attendance-related models

// Attendance model
model Attendance {
    id                  String           @id @default(cuid())
    userId              String
    courseId            String
    date                DateTime
    status              AttendanceStatus
    checkIn             DateTime?
    checkOut            DateTime?
    notes               String?
    markedBy            String?
    createdAt           DateTime         @default(now())
    updatedAt           DateTime         @updatedAt
    qRCodeId            String?
    attendanceSessionId String?

    // Relationships
    user              User               @relation("UserAttendance", fields: [userId], references: [id], map: "attendance_user_fkey")
    course            Course             @relation("CourseAttendance", fields: [courseId], references: [id])
    marker            User?              @relation("AttendanceMarker", fields: [markedBy], references: [id])
    student           Student            @relation("StudentAttendance", fields: [userId], references: [id], map: "attendance_student_fkey")
    qrcode            QRCode?            @relation("QRCodeAttendance", fields: [qRCodeId], references: [id])
    attendanceSession AttendanceSession? @relation("SessionAttendances", fields: [attendanceSessionId], references: [id])

    @@unique([userId, courseId, date])
    @@map("attendances")
}

// QR Code model
model QRCode {
    id          String       @id @default(cuid())
    code        String       @unique
    courseId    String
    teacherId   String
    validFrom   DateTime
    validUntil  DateTime
    maxUses     Int          @default(1)
    usedCount   Int          @default(0)
    status      QRCodeStatus @default(ACTIVE)
    location    String?
    description String?
    createdAt   DateTime     @default(now())
    updatedAt   DateTime     @updatedAt

    // Relationships
    course      Course       @relation("CourseQRCodes", fields: [courseId], references: [id])
    teacher     User         @relation("UserQRCodes", fields: [teacherId], references: [id])
    attendances Attendance[] @relation("QRCodeAttendance")
    checkIns    QRCheckIn[]  @relation("QRCodeCheckIns")

    @@map("qr_codes")
}

// Attendance Session model
model AttendanceSession {
    id        String    @id @default(cuid())
    courseId  String
    teacherId String
    date      DateTime
    startTime DateTime
    endTime   DateTime?
    isActive  Boolean   @default(true)
    location  String?
    notes     String?
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt

    // Relationships
    course      Course       @relation("CourseSessions", fields: [courseId], references: [id])
    teacher     User         @relation("TeacherSessions", fields: [teacherId], references: [id])
    attendances Attendance[] @relation("SessionAttendances")

    @@map("attendance_sessions")
}

// QR Check In model
model QRCheckIn {
    id          String   @id @default(cuid())
    qrCodeId    String
    userId      String
    checkInTime DateTime @default(now())
    location    String?
    ipAddress   String?
    userAgent   String?
    isValid     Boolean  @default(true)
    notes       String?
    createdAt   DateTime @default(now())

    // Relationships
    qrcode QRCode @relation("QRCodeCheckIns", fields: [qrCodeId], references: [id])
    user   User   @relation("UserQRCheckIns", fields: [userId], references: [id])

    @@map("qr_check_ins")
}
